<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikToolStream - Panel de Control</title>
  <link rel="icon" type="image/png" href="/assets/LOGOSINFONDO.png">

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Poppins:wght@400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap"
    rel="stylesheet">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="app-styles.css">
</head>

<body>
  <!-- Header con menÃº de usuario -->
  <header class="app-header">
    <div class="header-logo">
      <img src="assets/LOGOSINFONDO.png" alt="Logo" class="header-logo-img">
      <span class="header-title">TikToolStream</span>
    </div>
    <div class="header-user">
      <button id="menuToggle" class="menu-toggle">
        <span id="userName"></span>
        <span class="menu-arrow">â–¼</span>
      </button>
      <div id="userMenu" class="user-menu" style="display: none;">
        <a href="#" id="profileLink" class="menu-item">ğŸ‘¤ Mi Perfil</a>
        <a href="#" id="settingsLink" class="menu-item">âš™ï¸ ConfiguraciÃ³n</a>
        <div class="menu-divider"></div>
        <a href="#" id="logoutBtn" class="menu-item logout">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    </div>
  </header>

  <!-- Barra flotante de acciones -->
  <div class="floating-sidebar active" id="floatingSidebar">
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    <div class="sidebar-content" id="sidebarContent">
      <button class="sidebar-btn" id="openLeaderboardBtn" title="Abrir Overlay Leaderboard">
        ğŸ† <span>Overlay Top</span>
      </button>
      <button class="sidebar-btn" id="newsBtn" title="Novedades">
        ğŸ“° <span>Novedades</span>
      </button>
      <button class="sidebar-btn" id="chatBtn" title="Chat con Admin">
        ğŸ’¬ <span>Chat</span>
      </button>
    </div>
  </div>

  <!-- PartÃ­culas de fondo decorativas -->
  <div class="particles" id="particles"></div>

  <!-- Overlay para animaciones Ã©picas -->
  <div class="animation-overlay" id="animationOverlay"></div>

  <div class="app-container">
    <!-- ========================================
         PANEL DE CONTROL (Izquierda)
         ======================================== -->
    <aside class="control-panel">
      <div class="panel-header">
        <img src="assets/LOGOSINFONDO.png" alt="Logo" class="panel-logo">
        <h1 class="panel-title">Panel de Control</h1>
      </div>

      <!-- NavegaciÃ³n -->
      <nav class="panel-nav" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
        <a href="/index.html" class="nav-link active" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #00d9ff, #0099cc); color: white; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s;">
          ğŸ¯ Subasta
        </a>
        <a href="/roulette.html" class="nav-link" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s;">
          ğŸ° Ruleta
        </a>
      </nav>

      <!-- Banner de Plan/Trial -->
      <div id="planBanner" class="plan-banner" style="display: none;">
        <div class="plan-info">
          <span id="planText"></span>
        </div>
        <button id="upgradePlan" class="btn-upgrade" style="display: none;">
          ğŸ’ Actualizar a Pro
        </button>
      </div>

      <!-- ConexiÃ³n TikTok -->
      <section class="panel-section">
        <label class="panel-label">Usuario TikTok</label>
        <div class="input-group">
          <span class="input-prefix">@</span>
          <input type="text" id="tiktokUserInput" class="input-field" placeholder="username" autocomplete="off">
        </div>

        <div class="btn-group" style="margin-top: 0.75rem;">
          <button id="tiktokConnect" class="btn btn-primary" style="flex: 1;">Conectar</button>
        </div>

        <div class="status-display">
          <span class="status-dot" id="statusDot"></span>
          <span id="connectionStatus">Sin conexiÃ³n</span>
        </div>
        <p id="connectionFeedback" class="panel-feedback"></p>
        <p class="status-display">Usuario: <strong id="tiktokUserDisplay">â€”</strong></p>

        <!-- SecciÃ³n de Session ID (colapsable) -->
        <details class="auth-details" id="authDetails">
          <summary class="auth-summary">ğŸ” Configurar Session ID (opcional)</summary>
          <div class="auth-content">
            <p class="auth-help">Si tienes problemas de conexiÃ³n, configura tu Session ID de TikTok:</p>
            <ol class="auth-steps">
              <li>Abre <a href="https://www.tiktok.com" target="_blank">tiktok.com</a> e inicia sesiÃ³n</li>
              <li>Presiona F12 â†’ Application â†’ Cookies</li>
              <li>Copia el valor de <code>sessionid</code></li>
            </ol>
            <div class="input-group" style="margin-top: 0.5rem;">
              <input type="password" id="sessionIdInput" class="input-field" placeholder="Session ID">
            </div>
            <div class="input-group" style="margin-top: 0.5rem;">
              <input type="text" id="ttTargetIdcInput" class="input-field" placeholder="tt-target-idc (ej: useast1a)">
            </div>
            <button id="saveSessionId" class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;">Guardar
              Credenciales</button>
          </div>
        </details>
      </section>

      <!-- Controles de Subasta -->
      <section class="panel-section">
        <label class="panel-label">Controles de Subasta</label>
        <div class="btn-group">
          <button id="timerPlay" class="btn btn-primary">â–¶ Iniciar</button>
          <button id="timerReset" class="btn btn-secondary">â†º Reiniciar</button>
        </div>
      </section>

      <!-- ConfiguraciÃ³n de Tiempos -->
      <section class="panel-section">
        <label class="panel-label">â±ï¸ Tiempos (segundos)</label>
        <div class="time-inputs">
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Inicial</label>
            <div class="input-group">
              <input type="number" id="initialTimeInput" class="input-field" value="120" min="10" max="600">
            </div>
          </div>
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Delay</label>
            <div class="input-group">
              <input type="number" id="delayTimeInput" class="input-field" value="20" min="0" max="120">
            </div>
          </div>
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Empate</label>
            <div class="input-group">
              <input type="number" id="tieExtensionInput" class="input-field" value="30" min="10" max="120">
            </div>
          </div>
        </div>
        <button id="updateTimes" class="btn btn-secondary" style="margin-top: 0.75rem; width: 100%;">Aplicar</button>
      </section>

      <!-- Mensaje del Timer -->
      <section class="panel-section">
        <label class="panel-label">ğŸ“ Mensaje</label>
        <div class="input-group">
          <input type="text" id="minMessageInput" class="input-field" placeholder="MIN 10" maxlength="20">
        </div>
        <button id="updateMinMessage" class="btn btn-secondary"
          style="margin-top: 0.5rem; width: 100%;">Actualizar</button>
      </section>

      <!-- Suma Manual -->
      <section class="panel-section">
        <label class="panel-label">ğŸ’ Suma Manual</label>
        <div class="input-group" style="margin-bottom: 0.5rem;">
          <span class="input-prefix">@</span>
          <input type="text" id="manualUserInput" class="input-field" placeholder="usuario">
        </div>
        <div class="input-group">
          <input type="number" id="manualCoinsInput" class="input-field" placeholder="Monedas" min="1">
        </div>
        <button id="addManualCoins" class="btn btn-success" style="margin-top: 0.75rem; width: 100%;">+ Agregar
          Monedas</button>
      </section>
    </aside>

    <!-- ========================================
         CONTENIDO PRINCIPAL (Derecha)
         ======================================== -->
    <main class="main-content">
      <!-- Timer Card - OVERLAY EN VIVO -->
      <div class="timer-card" id="timerCard" style="min-height: 400px; height: auto; overflow: hidden; position: relative;">
        <iframe
          id="timerOverlayFrame"
          src="/overlay-timer.html"
          style="width: 100%; height: 450px; min-height: 450px; border: none; display: block; border-radius: 16px; background: transparent; transform: scale(0.95); transform-origin: center top;"
          allowtransparency="true"
          scrolling="no"
        ></iframe>
      </div>

      <!-- URL del Overlay para OBS/TikTok Live Studio -->
      <div class="overlay-url-section" style="background: linear-gradient(135deg, rgba(30,40,60,0.95), rgba(20,30,50,0.98)); border-radius: 16px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
          <span style="font-size: 1.5rem;">ğŸ¥</span>
          <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #fff;">URL para OBS / TikTok Live Studio</h3>
        </div>
        <p style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.4;">
          Copia esta URL y pÃ©gala en <strong>Browser Source</strong> de OBS o TikTok Live Studio
        </p>
        <div style="display: flex; gap: 0.5rem; align-items: stretch;">
          <input
            type="text"
            id="overlayUrlInput"
            readonly
            value=""
            style="flex: 1; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #00d9ff; font-family: 'Courier New', monospace; font-size: 0.9rem;"
          >
          <button
            id="copyOverlayUrlBtn"
            style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #00d9ff, #0099cc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; white-space: nowrap;"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,217,255,0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
          >
            ğŸ“‹ Copiar URL
          </button>
        </div>
        <div id="copyFeedback" style="margin-top: 0.5rem; font-size: 0.85rem; color: #00ff88; opacity: 0; transition: opacity 0.3s;">
          âœ“ URL copiada al portapapeles
        </div>
      </div>

      <!-- Leaderboard Card -->
      <div class="leaderboard-card">
        <header class="leaderboard-header">
          <div>
            <h2 class="leaderboard-title">ğŸ† Top Donadores</h2>
          </div>
        </header>

        <ol class="leaderboard-list" id="donorList">
          <li class="leaderboard-empty">
            <div class="leaderboard-empty-icon">ğŸ’</div>
            <p>Esperando donaciones...</p>
          </li>
        </ol>

        <footer class="leaderboard-footer" id="leaderboardFooter">
          <img src="assets/LOGOSINFONDO.png" alt="Logo" class="winner-logo">
          <span class="winner-label">ğŸ‰ Ganador de la Subasta by Tiktoolstream</span>
          <div class="winner-display" id="winnerDisplay">â€”</div>
        </footer>
      </div>
    </main>
  </div>

  <!-- Modal de Novedades -->
  <div id="newsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“° Novedades y Actualizaciones</h2>
        <button class="modal-close" id="newsClose">&times;</button>
      </div>
      <div class="modal-body">
        <div id="newsList" class="news-list">
          <p id="newsLoading" class="loading-text">Cargando novedades...</p>
          <p id="newsEmpty" class="info-text" style="display: none;">No hay novedades publicadas</p>
        </div>
        <div id="newsForm" class="news-form" style="display: none;">
          <h3>Publicar Novedad</h3>
          <input type="text" id="newsTitle" placeholder="TÃ­tulo" class="modal-input">
          <textarea id="newsContent" placeholder="Contenido..." class="modal-textarea"></textarea>
          <input type="file" id="newsImage" accept="image/*" class="modal-file">
          <button id="postNews" class="btn btn-primary">Publicar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="chatModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ’¬ Chat con Administrador</h2>
        <button class="modal-close" id="chatClose">&times;</button>
      </div>
      <div class="modal-body">
        <div id="chatMessages" class="chat-messages">
          <p id="chatLoading" class="loading-text">Cargando mensajes...</p>
        </div>
        <div class="chat-input-area">
          <input type="file" id="chatFileInput" accept="image/*" class="chat-file" style="display: none;">
          <button id="chatFileBtn" class="btn-icon" title="Adjuntar imagen">ğŸ“</button>
          <input type="text" id="chatInput" placeholder="Escribe un mensaje..." class="chat-input">
          <button id="chatSendBtn" class="btn btn-primary">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script de partÃ­culas -->
  <script>
    // Crear partÃ­culas decorativas
    const particlesContainer = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (15 + Math.random() * 10) + 's';
      particlesContainer.appendChild(particle);
    }
  </script>

  <!-- ProtecciÃ³n de autenticaciÃ³n -->
  <script type="module">
    import { isLoggedIn, isGuest, getAccessToken } from './modules/auth.js';

    // Verificar si el usuario estÃ¡ autenticado
    (async function checkAuth() {
      console.log('[AUTH] Verificando autenticaciÃ³n...');
      
      const loggedIn = isLoggedIn();
      const guest = isGuest();
      const token = getAccessToken();
      
      console.log('[AUTH] Estado:', { loggedIn, guest, hasToken: !!token });
      
      if (!loggedIn && !guest) {
        console.log('[AUTH] No autenticado, redirigiendo a login');
        window.location.href = '/login.html';
        return;
      }
      
      if (loggedIn) {
        // Verificar rol directamente del localStorage primero
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            console.log('[AUTH] Usuario logueado:', user.username, 'Rol:', user.role);
            if (user.role === 'admin') {
              console.log('[AUTH] Admin detectado, redirigiendo...');
              window.location.href = '/admin.html';
              return;
            }
          } catch (e) {
            console.error('[AUTH] Error parsing user data:', e);
          }
        }
      }
      
      if (guest) {
        console.log('[AUTH] Usuario invitado permitido');
      }
      
      console.log('[AUTH] AutenticaciÃ³n OK, cargando aplicaciÃ³n...');
    })();
  </script>

  <!-- Script para URL del Overlay -->
  <script>
    // Configurar URL del overlay
    document.addEventListener('DOMContentLoaded', () => {
      const overlayUrlInput = document.getElementById('overlayUrlInput');
      const copyOverlayUrlBtn = document.getElementById('copyOverlayUrlBtn');
      const copyFeedback = document.getElementById('copyFeedback');

      // Generar URL completa del overlay
      const overlayUrl = `${window.location.origin}/overlay-timer.html`;
      overlayUrlInput.value = overlayUrl;

      console.log('[Overlay-URL] URL generada:', overlayUrl);

      // Copiar URL al portapapeles
      copyOverlayUrlBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(overlayUrl);
          console.log('[Overlay-URL] URL copiada:', overlayUrl);

          // Mostrar feedback
          copyFeedback.style.opacity = '1';
          copyOverlayUrlBtn.textContent = 'âœ“ Copiado!';

          // Resetear despuÃ©s de 2 segundos
          setTimeout(() => {
            copyFeedback.style.opacity = '0';
            copyOverlayUrlBtn.textContent = 'ğŸ“‹ Copiar URL';
          }, 2000);
        } catch (err) {
          console.error('[Overlay-URL] Error al copiar:', err);
          alert('Error al copiar la URL. Por favor cÃ³piala manualmente.');
        }
      });
    });
  </script>

  <!-- MÃ³dulo principal -->
  <script type="module" src="main.js"></script>
</body>

</html>