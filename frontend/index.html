<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikToolStream - Panel de Control</title>
  <link rel="icon" type="image/png" href="/assets/LOGOSINFONDO.png">

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Poppins:wght@400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap"
    rel="stylesheet">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="app-styles.css">
</head>

<body>
  <!-- Header con men√∫ de usuario -->
  <header class="app-header">
    <div class="header-logo">
      <img src="assets/LOGOSINFONDO.png" alt="Logo" class="header-logo-img">
      <span class="header-title">TikToolStream</span>
    </div>
    <div class="header-user">
      <button id="menuToggle" class="menu-toggle">
        <span id="userName"></span>
        <span class="menu-arrow">‚ñº</span>
      </button>
      <div id="userMenu" class="user-menu" style="display: none;">
        <a href="#" id="profileLink" class="menu-item">üë§ Mi Perfil</a>
        <a href="#" id="settingsLink" class="menu-item">‚öôÔ∏è Configuraci√≥n</a>
        <div class="menu-divider"></div>
        <a href="#" id="logoutBtn" class="menu-item logout">üö™ Cerrar Sesi√≥n</a>
      </div>
    </div>
  </header>

  <!-- Barra flotante de acciones -->
  <div class="floating-sidebar active" id="floatingSidebar">
    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
    <div class="sidebar-content" id="sidebarContent">
      <button class="sidebar-btn" id="openLeaderboardBtn" title="Abrir Overlay Leaderboard">
        üèÜ <span>Overlay Top</span>
      </button>
      <button class="sidebar-btn" id="openTimerBtn" title="Abrir Overlay Timer">
        ‚è±Ô∏è <span>Overlay Timer</span>
      </button>
      <button class="sidebar-btn" id="newsBtn" title="Novedades">
        üì∞ <span>Novedades</span>
      </button>
      <button class="sidebar-btn" id="chatBtn" title="Chat con Admin">
        üí¨ <span>Chat</span>
      </button>
      <button class="sidebar-btn" id="overlayBtn" title="Personalizar Overlay">
        üé® <span>Personalizar</span>
      </button>
    </div>
  </div>

  <!-- Part√≠culas de fondo decorativas -->
  <div class="particles" id="particles"></div>

  <!-- Overlay para animaciones √©picas -->
  <div class="animation-overlay" id="animationOverlay"></div>

  <div class="app-container">
    <!-- ========================================
         PANEL DE CONTROL (Izquierda)
         ======================================== -->
    <aside class="control-panel">
      <div class="panel-header">
        <img src="assets/LOGOSINFONDO.png" alt="Logo" class="panel-logo">
        <h1 class="panel-title">Panel de Control</h1>
      </div>

      <!-- Banner de Plan/Trial -->
      <div id="planBanner" class="plan-banner" style="display: none;">
        <div class="plan-info">
          <span id="planText"></span>
        </div>
        <button id="upgradePlan" class="btn-upgrade" style="display: none;">
          üíé Actualizar a Pro
        </button>
      </div>

      <!-- Conexi√≥n TikTok -->
      <section class="panel-section">
        <label class="panel-label">Usuario TikTok</label>
        <div class="input-group">
          <span class="input-prefix">@</span>
          <input type="text" id="tiktokUserInput" class="input-field" placeholder="username" autocomplete="off">
        </div>

        <div class="btn-group" style="margin-top: 0.75rem;">
          <button id="tiktokConnect" class="btn btn-primary" style="flex: 1;">Conectar</button>
        </div>

        <div class="status-display">
          <span class="status-dot" id="statusDot"></span>
          <span id="connectionStatus">Sin conexi√≥n</span>
        </div>
        <p id="connectionFeedback" class="panel-feedback"></p>
        <p class="status-display">Usuario: <strong id="tiktokUserDisplay">‚Äî</strong></p>

        <!-- Secci√≥n de Session ID (colapsable) -->
        <details class="auth-details" id="authDetails">
          <summary class="auth-summary">üîê Configurar Session ID (opcional)</summary>
          <div class="auth-content">
            <p class="auth-help">Si tienes problemas de conexi√≥n, configura tu Session ID de TikTok:</p>
            <ol class="auth-steps">
              <li>Abre <a href="https://www.tiktok.com" target="_blank">tiktok.com</a> e inicia sesi√≥n</li>
              <li>Presiona F12 ‚Üí Application ‚Üí Cookies</li>
              <li>Copia el valor de <code>sessionid</code></li>
            </ol>
            <div class="input-group" style="margin-top: 0.5rem;">
              <input type="password" id="sessionIdInput" class="input-field" placeholder="Session ID">
            </div>
            <div class="input-group" style="margin-top: 0.5rem;">
              <input type="text" id="ttTargetIdcInput" class="input-field" placeholder="tt-target-idc (ej: useast1a)">
            </div>
            <button id="saveSessionId" class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;">Guardar
              Credenciales</button>
          </div>
        </details>
      </section>

      <!-- Controles de Subasta -->
      <section class="panel-section">
        <label class="panel-label">Controles de Subasta</label>
        <div class="btn-group">
          <button id="timerPlay" class="btn btn-primary">‚ñ∂ Iniciar</button>
          <button id="timerReset" class="btn btn-secondary">‚Ü∫ Reiniciar</button>
        </div>
      </section>

      <!-- Configuraci√≥n de Tiempos -->
      <section class="panel-section">
        <label class="panel-label">‚è±Ô∏è Tiempos (segundos)</label>
        <div class="time-inputs">
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Inicial</label>
            <div class="input-group">
              <input type="number" id="initialTimeInput" class="input-field" value="120" min="10" max="600">
            </div>
          </div>
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Delay</label>
            <div class="input-group">
              <input type="number" id="delayTimeInput" class="input-field" value="20" min="0" max="120">
            </div>
          </div>
          <div class="time-input">
            <label class="panel-label" style="font-size: 0.65rem;">Empate</label>
            <div class="input-group">
              <input type="number" id="tieExtensionInput" class="input-field" value="30" min="10" max="120">
            </div>
          </div>
        </div>
        <button id="updateTimes" class="btn btn-secondary" style="margin-top: 0.75rem; width: 100%;">Aplicar</button>
      </section>

      <!-- Mensaje del Timer -->
      <section class="panel-section">
        <label class="panel-label">üìù Mensaje</label>
        <div class="input-group">
          <input type="text" id="minMessageInput" class="input-field" placeholder="MIN 10" maxlength="20">
        </div>
        <button id="updateMinMessage" class="btn btn-secondary"
          style="margin-top: 0.5rem; width: 100%;">Actualizar</button>
      </section>

      <!-- Suma Manual -->
      <section class="panel-section">
        <label class="panel-label">üíé Suma Manual</label>
        <div class="input-group" style="margin-bottom: 0.5rem;">
          <span class="input-prefix">@</span>
          <input type="text" id="manualUserInput" class="input-field" placeholder="usuario">
        </div>
        <div class="input-group">
          <input type="number" id="manualCoinsInput" class="input-field" placeholder="Monedas" min="1">
        </div>
        <button id="addManualCoins" class="btn btn-success" style="margin-top: 0.75rem; width: 100%;">+ Agregar
          Monedas</button>
      </section>
    </aside>

    <!-- ========================================
         CONTENIDO PRINCIPAL (Derecha)
         ======================================== -->
    <main class="main-content">
      <!-- Timer Card - DISE√ëO √âPICO -->
      <div class="timer-card" id="timerCard">
        <div class="timer-glow"></div>
        <div class="timer-bg-effects"></div>

        <!-- Mascota Izquierda - Cocodrilo -->
        <div class="timer-mascot mascot-left">
          <img src="assets/QuesadillaCrocodilla.webp" alt="Mascota Cocodrilo" class="mascot-img" id="mascotLeftImg">
          <div class="mascot-speech" id="mascotSpeechLeft">¬°VAMOS!</div>
        </div>

        <!-- Contenido Central del Timer -->
        <div class="timer-content">
          <h2 class="timer-label" id="timerHeading">MIN 10</h2>

          <!-- DISPLAY GIGANTE DEL TIMER -->
          <div class="timer-display-wrapper">
            <div class="timer-display" id="timerDisplay">02:00</div>
            <div class="timer-display-shadow">02:00</div>
          </div>

          <div class="timer-message" id="timerMessage"></div>

          <!-- Barra de progreso -->
          <div class="timer-progress-bar">
            <div class="timer-progress-fill" id="timerProgressFill"></div>
          </div>
        </div>

        <!-- Mascota Derecha - Santa -->
        <div class="timer-mascot mascot-right">
          <img src="assets/Noel.webp" alt="Mascota Noel" class="mascot-img" id="mascotRightImg">
          <div class="mascot-speech" id="mascotSpeechRight">¬°Sipe!</div>
        </div>

        <!-- Efectos de urgencia -->
        <div class="timer-urgency-overlay" id="timerUrgencyOverlay"></div>
      </div>

      <!-- Leaderboard Card -->
      <div class="leaderboard-card">
        <header class="leaderboard-header">
          <div>
            <h2 class="leaderboard-title">üèÜ Top Donadores</h2>
          </div>
        </header>

        <ol class="leaderboard-list" id="donorList">
          <li class="leaderboard-empty">
            <div class="leaderboard-empty-icon">üíé</div>
            <p>Esperando donaciones...</p>
          </li>
        </ol>

        <footer class="leaderboard-footer" id="leaderboardFooter">
          <img src="assets/LOGOSINFONDO.png" alt="Logo" class="winner-logo">
          <span class="winner-label">üéâ Ganador de la Subasta by Tiktoolstream</span>
          <div class="winner-display" id="winnerDisplay">‚Äî</div>
        </footer>
      </div>
    </main>
  </div>

  <!-- Modal de Novedades -->
  <div id="newsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì∞ Novedades y Actualizaciones</h2>
        <button class="modal-close" id="newsClose">&times;</button>
      </div>
      <div class="modal-body">
        <div id="newsList" class="news-list">
          <p id="newsLoading" class="loading-text">Cargando novedades...</p>
          <p id="newsEmpty" class="info-text" style="display: none;">No hay novedades publicadas</p>
        </div>
        <div id="newsForm" class="news-form" style="display: none;">
          <h3>Publicar Novedad</h3>
          <input type="text" id="newsTitle" placeholder="T√≠tulo" class="modal-input">
          <textarea id="newsContent" placeholder="Contenido..." class="modal-textarea"></textarea>
          <input type="file" id="newsImage" accept="image/*" class="modal-file">
          <button id="postNews" class="btn btn-primary">Publicar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="chatModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üí¨ Chat con Administrador</h2>
        <button class="modal-close" id="chatClose">&times;</button>
      </div>
      <div class="modal-body">
        <div id="chatMessages" class="chat-messages">
          <p id="chatLoading" class="loading-text">Cargando mensajes...</p>
        </div>
        <div class="chat-input-area">
          <input type="file" id="chatFileInput" accept="image/*" class="chat-file" style="display: none;">
          <button id="chatFileBtn" class="btn-icon" title="Adjuntar imagen">üìé</button>
          <input type="text" id="chatInput" placeholder="Escribe un mensaje..." class="chat-input">
          <button id="chatSendBtn" class="btn btn-primary">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Overlay Personalizado -->
  <div id="overlayModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üé® Mi Overlay Personalizado</h2>
        <button class="modal-close" id="overlayClose">&times;</button>
      </div>
      <div class="modal-body">
        <p class="info-text">Personaliza las im√°genes de tu overlay (brainrots laterales)</p>
        <div class="overlay-settings">
          <div class="overlay-setting">
            <label>Imagen Izquierda (Actual: QuesadillaCrocodilla)</label>
            <input type="file" id="overlayLeft" accept="image/*" class="modal-file">
            <img id="overlayLeftPreview" src="assets/QuesadillaCrocodilla.webp" class="overlay-preview">
          </div>
          <div class="overlay-setting">
            <label>Imagen Derecha (Actual: Noel)</label>
            <input type="file" id="overlayRight" accept="image/*" class="modal-file">
            <img id="overlayRightPreview" src="assets/Noel.webp" class="overlay-preview">
          </div>
          <button id="overlaySaveBtn" class="btn btn-primary">Guardar Overlay</button>
          <button id="resetOverlay" class="btn btn-secondary">Restaurar Predeterminado</button>
        </div>
        <div class="overlay-link">
          <label>URL de tu Overlay:</label>
          <input type="text" id="overlayLinkInput" readonly class="modal-input">
          <button id="copyOverlayBtn" class="btn btn-secondary">Copiar URL</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script de part√≠culas -->
  <script>
    // Crear part√≠culas decorativas
    const particlesContainer = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (15 + Math.random() * 10) + 's';
      particlesContainer.appendChild(particle);
    }
  </script>

  <!-- Protecci√≥n de autenticaci√≥n -->
  <script type="module">
    import { isLoggedIn, isGuest, getUser, getAccessToken } from './modules/auth.js';

    // Funci√≥n para verificar si el usuario es admin (incluye llamada API)
    async function checkAndRedirect() {
      if (!isLoggedIn() && !isGuest()) {
        window.location.href = '/login.html';
        return;
      }
      
      if (isLoggedIn()) {
        // Primero verificar localStorage
        const user = getUser();
        if (user?.role === 'admin') {
          window.location.href = '/admin.html';
          return;
        }
        
        // Si no hay rol en localStorage, verificar con API (una sola vez)
        if (!user?.role && !sessionStorage.getItem('roleChecked')) {
          try {
            sessionStorage.setItem('roleChecked', 'true');
            const token = getAccessToken();
            const response = await fetch('/api/auth/profile', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              const profile = await response.json();
              if (profile.role === 'admin') {
                // Actualizar localStorage y redirigir
                const storage = localStorage.getItem('accessToken') ? localStorage : sessionStorage;
                const existingUser = user || {};
                storage.setItem('user', JSON.stringify({ ...existingUser, role: 'admin' }));
                window.location.href = '/admin.html';
              }
            }
          } catch (e) {
            console.error('Error verificando rol:', e);
          }
        }
      }
    }
    
    checkAndRedirect();
  </script>

  <!-- M√≥dulo principal -->
  <script type="module" src="main.js"></script>
</body>

</html>